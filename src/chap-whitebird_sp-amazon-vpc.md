---
class: chapter
---

# Amazon VPCには AWSを理解するのに大事なことが全部詰まっている！

<div class="flush-right">
白鳥 翔太@whitebird_sp
</div>

## Amazon VPCとは？
本書をお読みの方はすでに説明不要かもしれませんが、Amazon VPCはAWS内に論理的に分離されたネットワーク環境を作ることができるサービスで、リソースの配置、接続性、セキュリティなど、仮想ネットワーク環境をフルで制御できるサービスです。

* AWS上できめ細やかなネットワーク設定ができることで、セキュリティの向上、可用性の向上、モニタリング・スケーリングができる
* インフラストラクチャーの設計はAWS側で行うため、物理ルータ・スイッチ等の設定を意識せず、自身の持つネットワークの拡張として利用できる
* 独自のIPアドレス範囲の選択や、IPv4/IPv6の選択、接続先の選択など大規模化にも対応できる

Amazon VPCを利用することで、次のような機能を利用することができるようになります。
* 仮想プライベートクラウド
* サブネット
* セキュリティグループとネットワークアクセスリスト
* IPアドレスの指定
* ルーティング
* ゲートウェイとエンドポイント
* ピアリング接続
* トラフィックのミラーリング
* VPC Flow logs
* VPN接続

本記事では機能説明ではなくて、推しポイントなので機能については省略します。

## Amazon VPCの歴史

Amazon VPC自体は2009年にプレビュー版がリリースされました。リリース文章を読むと、このようなことが書いてあります。

「Amazon VPC enables enterprises to connect their existing infrastructure to a set of isolated AWS compute resources via a Virtual Private Network (VPN) connection, and to extend their existing management capabilities such as security services, firewalls, and intrusion detection systems to include their AWS resources.」

（翻訳）Amazon VPCは、仮想プライベートネットワーク（VPN）接続を介して、既存のインフラストラクチャと分離されたAWSコンピュートリソースに接続し、セキュリティサービス、ファイアウォール、侵入検知システムなどの既存の管理機能をAWSリソースに拡張することを可能にします。

（出典：https://aws.amazon.com/jp/about-aws/whats-new/2009/08/26/introducing-amazon-virtual-private-cloud/）

つまり、今日当たり前とされている機能のほとんどは存在せず、既存のエンタープライズネットワークの拡張としてシンプルな設計がされていたサービスであるということがわかります。

その後、主な機能のアップデートは次のようになります。

|年|月|主なアップデート|
|---|---|---|
|2009年|12月|制限なしのベータ版|
|2011年|3月|IGW/ElasticIP/NATInstance/SecurityGroup/NACLリリース|
|2011年|8月|マルチAZに対応|
|2011年|9月|Direct Connectリリース/東京リージョンに対応|
|2014年|3月|VPC Peeringリリース|
|2015年|6月|VPC Flow logsリリース|
|2015年|12月|NAT Gatewayのリリース|
|2016年|12月|IPv6に対応|
|2017年|11月|Privatelinkリリース|
|2018年|11月|Transit Gatewayリリース|
|2019年|7月|VPC Traffic Mirroringリリース|
|2019年|12月|Local Zonesに対応|
|2020年|11月|Network Firewallリリース|
|2020年|12月|Reachability Analyzerリリース|
|2021年|12月|Network Access Analyzer/IPAM/Cloud WANリリース|
|2022年|12月|VPC Latticeリリース|
|2023年|11月|マルチVPC-ENI対応|
|2024年|11月|VPC ブロックパブリックアクセス対応|

他にも多数の新機能がありますが、初期リリースから15年以上たった今でも毎年何かしらのアップデートがあるすごいサービスとなっています。

## Amazon VPCの推しポイント

### Working Backwardsに基づいた課題解決と体験の変革
初期の機能は「エンタープライズネットワークをAWSまで拡張したい」という課題を解決するものでした。エンタープライズネットワークとして利用するにあたり、様々な機能が追加され、今日では複雑なネットワークを作れるようになっています。オンプレミスの環境をベースにしたネットワークだけではなく、AWSをメインにネットワークを構築してから、オンプレミス側のネットワークの設計を行ったり、監視や運用もAWSからオンプレミスから行うような設計も行えるようになっています。

### デフォルトでも数クリックで使い始めることができる
一方で、高度な設計を必要としないネットワークにおいては、デフォルトの設定でもIPアドレスを払い出し、数クリックまたはCLI一つで起動できるようになっています。このネットワークも複数のAZにまたがったり、プライベートセグメント、インターネットに公開するセグメントといった分割が容易に行え、数分で使い始めることができる手軽さも持っています。

### Well-Architected Frameworkを考慮した設計の柔軟さ
Amazon VPCを一つ構築する際にもWell-Architected Frameworkの6つの柱をフルに考慮することができるため、AWSの概念を学ぶ上では非常に重要なサービスとなっています。例えば、次のようなポイントです。

#### 運用上の優秀性（Operational Excellence）
* VPC Flow Logsを有効化して、ネットワークトラフィックの監視と分析を行う
* Network Access AnalyzerとReachability Analyzerを有効化して、適切な経路の監視と分析を行う 
* インフラストラクチャをコード化（IaC）してVPC設定を管理する（AWS CloudFormationやTerraformなど）
* タグ付けの戦略を導入し、リソースの管理と追跡を容易にする
* 自動化されたテストと検証のプロセスを確立する

#### セキュリティ（Security）
* セキュリティグループとネットワークACLおよびVPCエンドポイントポリシーを適切に設計し、最小権限の原則を適用する
* VPCエンドポイントを使用して、プライベートな接続を確保する
* インターネットに公開する必要のないリソースはプライベートサブネットに配置する
* AWS GuardDutyなどのサービスを活用して、不審なアクティビティを検出する
* 暗号化の適用を行う（転送中および保存中のデータを暗号化する）

#### 信頼性（Reliability）
* 複数のアベイラビリティゾーン（AZ）にわたるマルチAZ構成を採用する
* サブネットごとに適切なCIDRブロックサイズを計画し、将来の拡張に備える
* VPCピアリングやTransit Gatewayを使って冗長なネットワーク接続を確保する
* 障害シナリオをテストし、復旧計画を策定する
* 静的安定性を踏まえたリソースの配置を行う
* DNS解決のためのRoute 53 Resolverの適切な設定を行う

#### パフォーマンス効率（Performance Efficiency）
* VPCエンドポイントを活用して、AWSサービスへの直接接続を確立する
* アプリケーションの要件に基づいて、適切なインスタンスタイプとネットワークキャパシティを選択する
* ネットワークレイテンシを最小化するためのリージョンの選択とリソース配置を検討する
* 必要に応じてAccelerated Site-to-Site VPN接続やAWS Direct Connectを検討する
* トラフィックのスケーリングに対応するための設計を行う

#### コスト最適化（Cost Optimization）
* NAT Gatewayやその他の有料サービスの利用を最適化する
* VPCエンドポイントの使用によるデータ転送コストの削減
* 不要なリソースを定期的に確認し、削除する

#### 持続可能性（Sustainability）
* リソースの使用率を最適化し、無駄なプロビジョニングを避ける
* アプリケーションパターンを見直し、効率的なネットワーク使用を促進する
* ワークロードの地理的配置を考慮し、再生可能エネルギーを多く利用するリージョンを選択する
* リソースの使用状況を継続的に監視し、効率化の機会を特定する
* インフラの使用率を向上させ、必要なリソースを最小限に抑える

### 時代に合わせて進化し続けるネットワーク構成
単純なエンタープライズネットワークの拡張にとどまらず、時代に合わせてネットワーク構成の変化にも対応しています。アップデートにおいては、いくつかの傾向がありますが、次のような傾向が見受けられます。

#### 企業の独立した内部ネットワーク環境で必要な機能の拡張
* 他のユーザの通信と重複することなく、ネットワークの到達性を確保できること
* 内部のネットワーク設定を簡単に実現できる、またはあまり意識せずに作れること
* ネットワークのトラブルシューティングを迅速に行えること
* エンタープライズネットワークに求められるネットワークセキュリティを確保できること

#### 外部ネットワークとの接続に必要な機能の拡張
* AWSにある他のVPCと接続できること
* VPCとAWS外部のネットワークをWAN接続できること（Site-to-Site VPN/Direct Connect/Cloud WAN）
* 端末・ユーザなど細かいレベルでAWS接続を制御できること

#### 大規模対応（マルチアカウント・マルチリージョン・ハイブリッド）
* マルチアカウント環境・マルチリージョン環境のVPCを接続できること
* IPアドレスが重複しないよう、払い出しを管理できること
* よりオンプレミスに近い場所でAWS環境を利用できるようになること（Local Zones/OutPosts）
* インバウンドやアウトバウンドの通信を一元化できること
* ネットワーク監視を一元化できること
* ガバナンスを管理できること

#### クラウドネイティブな構成への対応（コンテナネットワーク・サービスメッシュ・マイクロサービス化）
* IPアドレスが重複していてもアプリケーション同士が接続可能なこと
* VPC自体もイミュータブルに扱えること


## まとめ
Amazon VPCはAWSの初心者でも利用することの多いサービスですが、ちゃんと設計しようと思うとIPアドレス範囲の払い出し一つとっても考慮することが多く、非常に奥が深いサービスとなっています。ネットワークのことを知れば知るほどたくさんのことを考慮でき、また複雑な構成を作ることもできるようになっています。ネットワーク自体が難しいという声も最近では聞くようになりましたが、VPCを設計しながら、Well-Architected FrameworkなどAWSの基本原則の理解を深めてみるのもよいと思います。

#### 著者紹介

---

<div class="author-profile">
    <img src="images/whitebird_sp.jpg">
    <div>
        <div>
            <b>白鳥 翔太</b>
            <a href="https://x.com/whitebird_sp">X@whitebird_sp</a>
        </div>
        <div>
            所属：NW-JAWS
        </div>
    </div>
</div>
<p style="margin-top: 0.5em; margin-bottom: 2em;">
ネットワークとクラウドを組み合わせるのが大好きなエンジニア。AWSの大規模イベントでWi-Fiのアクセスポイントを調査してる人がいたら大体私です。とある通信事業者の中の人。NW-JAWSの運営もやっています。好きなサービスはもちろんAmazon VPC<br>
・AWS Ambassadors<br>
・AWS Community Builder<br>
・Japan AWS Top Engineers<br>
・Japan AWS All Certifications Engineers
</p>