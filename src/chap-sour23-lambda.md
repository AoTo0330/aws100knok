---
class: chapter
---

# 閑散としたシステムほど推したい「Lambda」
<div class="flush-right">
大澤文孝@sour23
</div>

## Lambdaの概要
AWS Lambdaは、ご存じの人も多いと思いますが、サーバレスでプログラムを動かすことができる環境です。

### サーバレスとは

この「サーバレス」というのは、サーバーがないという意味ではなくて、サーバーをAWSが用意してくれるという意味です。僕たちがやらなければいけないのは、「Lambda関数」と呼ばれる関数を作って、それをAWS Lambdaに登録することです。登録すると、いわゆるスタンバイ状態になり、実行されようとしたときに、Lambdaランタイムと呼ばれる実行環境に展開され、そこで実行されます。この実行環境の準備、そして、実行そのものを都度、AWSが行ってくれるから、サーバーが必要ない、だから、サーバレスと呼ばれています。

![Lambda関数の実行](images/chap-sour23-lambda/fig01.drawio.svg){width=70%}

### Lambda関数が実行されるとき

こうして登録されたLambda関数は、「イベント」を引き金にして実行されます。

イベントは大きく、「同期」と「非同期」があります。同期の代表的なものが、「Webからの呼び出し」です。HTTP（S）で接続したときにLambda関数を実行できます。いわゆる、「Webのバックエンド処理」を作るのに使えます。API Gatewayと組み合わせる、もしくは、Lambda単体で使えます。

非同期は、AWSのさまざまなサービスと連携するものです。代表的なものは、Amazon S3。バケットにファイルが作成されたり、変更されたり、削除されたりしたタイミングでLambda関数を実行できます。Lambda関数が実行されたときには、対象のオブジェクト名（ファイル名）がわかるので、そのファイルを読み取って何か処理できます。よくある例は、「画像ファイルがアップロードされたときに、自動でサムネイル画像を作る」ような仕組みです。こうした仕組みは、S3だけでなくDynamoDBやAWS IoTなどでも使えるので、さまざまな、「ちょっとした処理のフック」によく使われます。


＠図入ル



### Lambdaのメリット

Lambdaのメリットは、第一に、スケールしやすいということです。実行されると必要に応じてランタイムに展開されますが、このランタイムの負荷について、僕らが考える必要はありません。デフォルトでは最大100個まで同時実行できます（申請すれば増やせます）。そのためクラウドネイティブとかスケーラビリティのような文脈で、Lambda、そして、サーバレスがもてはやされています。

第二のメリットは、コストを抑えられるという点です。Lambdaは「実行回数当たりの課金」です。Lambda関数を登録しただけでは無料で、実行した回数しか課金されません。そのため、閑散としたシステムであればあるほど、コストを抑えられます。

＠図入ル


<div class="column">
<div class="column-title">スタートの遅さを解決する</div>
Lambda関数は、必要になったときにLambdaランタイムに展開されるという仕組み上、初回の起動が遅いです。これは初回は、ランタイムを作って展開するという処理が行われるからです。

これを避けるため、Lambda関数をあらかじめ準備しておく「プロビジョニング」という設定にできます。プロビジョニングすると、ランタイムが作られてスタンバイ状態になるので、初回の起動の遅さがありません。ただしプロビジョニングしている間ずっとコストがかかるので、「実行回数当たりの課金」という、コストのメリットがなくなります。
</div>

## Lambdaによる画像アップローダーを作る

この記事のネタは、「Lambdaによる画像アップローダー」です。実際、これ案件として作ったものを、少し、改良したものです。

- 本人確認のために免許証やマイナンバーなどを集めなければならない
- 年に数十回（いいところ数百回）しか使わないから、コストをかけられない
- 本人確認資料をやりとりするので、セキュリティは万全でないとNG

こんな要件のシステムです。

### 構成図

構成は、下記の図のようにします。

- 各自のユーザー名とパスワードは、あらかじめ、DynamoDBに登録しておきます。ファイルをアップロードするときは、このユーザー名とパスワードを入力してもらいます。
- アップロードされたファイルはS3に保存します。1人1ファイルしか登録できないものとし、複数回アップロードしたときは、単純に上書きします。

## 開発コストを下げる工夫

このシステムは、ほとんど使われることがないという時点で、Lambdaの採用が決まりました。Lambdaなら、稼働しなければコストがかからないからです。

それ以外に、開発コストも抑えたいという要望がありました。そもそも、年に少ししか使わないのですから、開発コストをかけられないのは当たり前です。ですから、極力、いろんなものを作らないようにします。

### アップロードされた画像はS3 Browserで確認

アップロードされた画像を見るためのユーザーインターフェースは作らないことにしました。S3 Browserでアクセスすることで、直接、バケットにアップロードされた画像ファイルを参照することにします。

### DynamoDBへのユーザー登録はAWS CLIで

DynamoDBには、次のようなテーブルで、ユーザー名やパスワードを管理します。これ、登録画面を作るの、結構面倒くさいです（新規作成（C）、更新（U）、一覧（R）、削除（D）のいわゆる、CURDの一連操作に対応しないといけないからです）。

＠表入る

そこで簡易な方法として、Excelシートを使うことにしました。

Excelシートにユーザー名とパスワードを記載する列を用意しておき、その右側に、「aws cli ・・・」のようなDynamoDBに登録するAWS CLIのコマンドを書いておきます。

このコマンドをコピペすれば、DynamoDBに登録されるので、この方法で、管理画面を作らないことにしました。

＠SQLiteに書いてコピーするのもいいよ、みたいな話を書くかもしれない

## Lambdaって実はカンタン！

さて、肝心のLambda関数ですが、作るのは、そんなに難しくないです。

いまでこそ、「Serverless Frameworkを使って」みたいな面倒なことになってきましたが、たかだか、アップロードされたファイルを受け取って書き込む」のは、1本のLambda関数で作れるので、AWSマネジメントコンソールから行ってしまえばいいです。

### UI用を作る

まずは、Lambdaより前に、UI用のHTMLフォームを作ります。適当なS3バケットを作って、HTMLを置きます。下記のようなHTMLとしました。

＠HTML入れる（画像だけで引出線にするかも）

### 送信用のJavaScriptを作る

送信用のJavaScriptも作ります。次のような感じです。送信先のLambda関数の場所は、実際は、次に作るLambda関数のエンドポイントに合わせます。

＠JavaScript概要入れる

### Lambda関数を作る

そして主題となるLambda関数ですね。

まずは、アップロードされた画像を保存するS3バケットを作っておきます。

＠S3作るキャブ

そして、AWSマネジメントコンソールでLambda関数を作ります。ソースは、次のような感じです。ただ貼り付ければよいです。

＠リスト入ル


ポイントとなるのは、セキュリティです。このLambda関数は、S3バケットに保存できるようにする必要があるため、S3バケットへの書き込み権限が必要です。その設定をXXXXで行います。

このとき、読み取りの権限を付けないのがポイントです。そうすれば、読めない、つまり、アップロードした画像ファイルは、Web側からは参照できないので、安心です。

ここは設計の問題で、ユーザーが「過去にアップロードした画像を確認できる機能」を設けると、これができなくなるので、「アップロードした画像は確認できない。間違えたと思ったら、もう一度操作して、上書きしてね」という方法にすることで、簡単な方法でありながらセキュリティを担保しています。

### エンドポイントを作る

＠エンドポイントを作る方法について

### CloudFrontなどを構成して完成！

以上で終わりです。あとは、S3の手前にCloudFrontを構成して、HTTPS化するなどします。

## まとめ

大きな規模のサーバーレス開発だと、Visual Studio Codeを使ってどうこう、というようになりますが、こうした小さなプログラムなら、AWSマネジメントコンソールで実現できます。

昔のPerlとかPHPとかで書いていた「小さなCGI」のプログラムは、簡単にLambdaで実現できます。「掲示板」「チャット」「お問い合わせフォーム」など、「小さくて、閑散としたシステム」は、実は、Lambdaが、とっても向いています。

是非、Lambdaでいろいろ遊んでみてください！

#### 著者紹介
---

　

<div class="author-profile">
    <img src="images/sour23.jpg">
    <div>
        <div>
            <b>大澤文孝</b>
            <a href="https://twitter.com/sour23">X@sour23</a>
        </div>
        <div>
            サークル名：モウフカブール
        </div>
    </div>
</div>
<p style="margin-top: 0.5em; margin-bottom: 2em;">
「Amazon Web Services基礎からのネットワーク＆サーバー構築」（通称：紫本）、「AWSネットワーク入門」「ゼロからわかるAmazon Web Services超入門」「AWS Lambda実践ガイド」などのAWSに関する書籍をはじめ、多数の技術書を執筆。技書博や技術書典、コミケなどの同人イベントでは「モウフカブール」として、サークル参加しています。
</p>